function display(){document.getElementById("time")&&"--:--"!=document.getElementById("time").value&&(1==milisect&&0==secondst||0>secondst?(document.getElementById("time").value="--:--",""==document.getElementById("SaleReferenceId").value&&(document.getElementById("ResCode").value="415"),document.forms.returnForm.submit()):milisec>=59?(milisec=0,milisect=60,seconds+=1,secondst-=1):milisec+=1,milisect-=1,"--:--"!=document.getElementById("time").value&&(document.getElementById("time").value=secondst+":"+milisect,setTimeout("display()",1e3)))}function getParam(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t="[\\?&]"+e+"=([^&#]*)",n=new RegExp(t),d=n.exec(window.location.href);return null==d?"":d[1]}function keyHandler(){switch(event.keyCode){case 13:doPay_value()}}function check_KeyPress(e,t,n){var d=String.fromCharCode(event.keyCode),l=!1;for(i=0;i<n.length;i++)if(n.charAt(i)==d){l=!0;break}return l}function DoMask(e,t,n,d,l){DoNothing=0,KeyCode=event.keyCode,CurrentChar=String.fromCharCode(KeyCode),CurrentPos=n.value.length;for(var o=d.split(","),u=0;u<=o.length;u++)for(var c=0;c<=t.length;c++)c==o[u]&&t.substring(c,c+1)!=l&&(t=t.substring(0,c)+l+t.substring(c,t.length),n.value=t);return CurrentPos<e.length+o.length?"N"==e.charAt(CurrentPos)?isNaN(CurrentChar)?DoNothing=1:DoNothing=0:"/"==e.charAt(CurrentPos)?"/"==CurrentChar?DoNothing=0:DoNothing=1:"L"==e.charAt(CurrentPos)&&(isNaN(CurrentChar)?DoNothing=0:DoNothing=1):DoNothing=1,1==DoNothing&&(event.keyCode=0),!0}function canEN(){frmc.submit()}function doPay_value(){var e=!0;if(isSavedPanSelected()||(""==document.getElementById("W_PAN1").value||document.getElementById("W_PAN1").value.length<4?(document.getElementById("W_PAN1").style.background="#FEBFC0",e=!1):document.getElementById("W_PAN1").style.background="#FEFEFE",""==document.getElementById("W_PAN2").value||document.getElementById("W_PAN2").value.length<4?(document.getElementById("W_PAN2").style.background="#FEBFC0",e=!1):document.getElementById("W_PAN2").style.background="#FEFEFE",""==document.getElementById("W_PAN3").value||document.getElementById("W_PAN3").value.length<4?(document.getElementById("W_PAN3").style.background="#FEBFC0",e=!1):document.getElementById("W_PAN3").style.background="#FEFEFE",""==document.getElementById("W_PAN4").value||document.getElementById("W_PAN4").value.length<4||document.getElementById("W_PAN4").value<1e3?(document.getElementById("W_PAN4").style.background="#FEBFC0",e=!1):document.getElementById("W_PAN4").style.background="#FEFEFE"),""==document.getElementById("W_PIN").value||document.getElementById("W_PIN").value.length<4?(document.getElementById("W_PIN").style.background="#FEBFC0",e=!1):document.getElementById("W_PIN").style.background="#FEFEFE",""==document.getElementById("W_CVV2").value||document.getElementById("W_CVV2").value.length<3?(document.getElementById("W_CVV2").style.background="#FEBFC0",e=!1):document.getElementById("W_CVV2").style.background="#FEFEFE",document.getElementById("W_CAPTCHA")&&(""==document.getElementById("W_CAPTCHA").value||5!=document.getElementById("W_CAPTCHA").value.length?(document.getElementById("W_CAPTCHA").style.background="#FEBFC0",e=!1):document.getElementById("W_CAPTCHA").style.background="#FEFEFE"),isExpireDateVisible()){var t=document.getElementById("W_EXPIRE1");t.value?(t.style.background="#FEFEFE",t.value>12?(t.style.background="#FEBFC0",e=!1):1===t.value.length&&(t.value="0"+t.value)):(t.style.background="#FEBFC0",e=!1)}if(isExpireDateVisible()){var n=document.getElementById("W_EXPIRE2");n.value?(n.style.background="#FEFEFE",1===n.value.length&&(n.value="0"+n.value)):(n.style.background="#FEBFC0",e=!1)}if(null!=document.getElementById("W_EMAIL").value&&""!=document.getElementById("W_EMAIL").value){var d=/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,4})+$/,l=document.getElementById("W_EMAIL").value;l.match(d)?document.getElementById("W_EMAIL").style.background="#FEFEFE":(document.getElementById("W_EMAIL").style.background="#FEBFC0",e=!1)}return e}function reset(){document.getElementById("W_PAN1").style.background="",document.getElementById("W_PAN2").style.background="",document.getElementById("W_PAN3").style.background="",document.getElementById("W_PAN4").style.background="",document.getElementById("W_PIN").style.background="",document.getElementById("W_CVV2").style.background="",document.getElementById("W_EMAIL").style.background=""}function nextTab(e,t){if(e.value.length>=e.maxLength||t)switch(e.tabIndex){case 1:document.getElementById("W_PAN3").focus(),field=document.getElementById("W_PAN3");break;case 2:document.getElementById("W_PAN2").focus(),field=document.getElementById("W_PAN2");break;case 3:document.getElementById("W_PAN1").focus(),field=document.getElementById("W_PAN1");break;case 4:document.getElementById("W_PIN").focus(),field=document.getElementById("W_PIN");break;case 5:document.getElementById("W_CVV2").focus(),field=document.getElementById("W_CVV2");break;case 6:document.getElementById("W_EXPIRE1").focus(),field=document.getElementById("W_EXPIRE1");break;case 7:document.getElementById("W_EXPIRE2").focus(),field=document.getElementById("W_EXPIRE2");break;case 8:document.getElementById("W_CAPTCHA")?(document.getElementById("W_CAPTCHA").focus(),field=document.getElementById("W_CAPTCHA")):(document.getElementById("doPay").focus(),field=document.getElementById("doPay"));break;case 9:document.getElementById("doPay").focus(),field=document.getElementById("doPay");break;default:document.getElementById("W_PAN4").focus(),field=document.getElementById("W_PAN4")}}function nextTabs(e,t,n){if(46==n.keyCode||16==n.keyCode||0==n.keyCode||13==n.keyCode||8==n.keyCode||9==n.keyCode);else if(e.value.length>=e.maxLength||t)switch(e.tabIndex){case 1:document.getElementById("W_PAN3").focus(),field=document.getElementById("W_PAN3");break;case 2:document.getElementById("W_PAN2").focus(),field=document.getElementById("W_PAN2");break;case 3:document.getElementById("W_PAN1").focus(),field=document.getElementById("W_PAN1");break;case 4:document.getElementById("W_PIN").focus(),field=document.getElementById("W_PIN");break;case 5:document.getElementById("W_CVV2").focus(),field=document.getElementById("W_CVV2");break;case 6:isExpireDateVisible()?(document.getElementById("W_EXPIRE1").focus(),field=document.getElementById("W_EXPIRE1")):document.getElementById("W_CAPTCHA")?(document.getElementById("W_CAPTCHA").focus(),field=document.getElementById("W_CAPTCHA")):(document.getElementById("doPay").focus(),field=document.getElementById("doPay"));break;case 7:document.getElementById("W_EXPIRE2").focus(),field=document.getElementById("W_EXPIRE2");break;case 9:document.getElementById("W_EMAIL").focus(),field=document.getElementById("W_EMAIL");break;case 8:document.getElementById("W_CAPTCHA")?(document.getElementById("W_CAPTCHA").focus(),field=document.getElementById("W_CAPTCHA")):(document.getElementById("doPay").focus(),field=document.getElementById("doPay"));break;case 9:document.getElementById("doPay").focus(),field=document.getElementById("doPay")}}function doNotPaste(){clipboardData.clearData()}function c_random(){shuffleArray=shuffle([0,1,2,3,4,5,6,7,8,9]);for(var e=0;e<shuffleArray.length;e++){var t="btn"+e;document.getElementById(t).value="  "+shuffleArray[e]+"   "}}function getName(e){field=e}function fill(e){""!=field&&null!=field||(field=document.getElementById("W_PAN4")),"text"!=field.type&&"password"!=field.type||(value=e.value,field.value.length<field.maxLength&&(field.value+=trim(value)),nextTab(field,!1),field.focus())}function trim(e){return e=this!=window?this:e,e.replace(/^\s+/,"").replace(/\s+$/,"")}function backspace(){var e=field.value;"text"!=field.type&&"password"!=field.type||(field.value=e.substring(0,e.length-1))}function tab(){nextTab(field,!0)}function show(){var e=document.body.clientWidth-event.clientX,t=document.body.clientHeight-event.clientY;e<document.getElementById("help").offsetWidth?document.getElementById("help").style.left=document.body.scrollLeft+event.clientX-document.getElementById("help").offsetWidth:document.getElementById("help").style.left=document.body.scrollLeft+event.clientX,t<document.getElementById("help").offsetHeight?document.getElementById("help").style.top=document.body.scrollTop+event.clientY-document.getElementById("help").offsetHeight:document.getElementById("help").style.top=document.body.scrollTop+event.clientY,document.getElementById("help").style.display="block"}function hide(){document.getElementById("help").style.display="none"}function getEventKeyCode(e){var t;return t=window.event?event.keyCode:e.which}function numericOnKeypress(e){var t=getEventKeyCode(e);return ignoreKeys(t)?!0:isNumericKeysPressed(t)?!0:void(window.event?window.event.returnValue=!1:e.preventDefault())}function isNumericKeysPressed(e){return e>=48&&57>=e}function ignoreKeys(e){return 0==e?!0:13==e?!0:16==e?!0:8==e?!0:9==e}function panSelectChanged(e){var t=e.options[e.selectedIndex];"NO_PAN_SELECTED"===t.id?($(".PAN_INPUT_TR").show(),$("#EXPIRE_DATE_MASK_TD").hide(),$("#EXPIRE_DATE_TD").show(),document.getElementById("W_PAN4").focus(),field=document.getElementById("W_PAN4")):($(".PAN_INPUT_TR").hide(),-1!==t.value.indexOf("withExpireDate")?($("#EXPIRE_DATE_TD").hide(),$("#EXPIRE_DATE_MASK_TD").show()):($("#EXPIRE_DATE_MASK_TD").hide(),$("#EXPIRE_DATE_TD").show()),document.getElementById("W_PIN").focus(),field=document.getElementById("W_PIN")),document.getElementById("W_EXPIRE1").value="",document.getElementById("W_EXPIRE2").value="",document.getElementById("W_PIN").value="",document.getElementById("W_CVV2").value="";var n=document.getElementById("EMAIL_SELECT"),d=t.value.split("#");if(d.length>1){var l=d[1];if(document.getElementById("W_EMAIL").value=l,n)for(var o=0;o<n.options.length;o++)l===n.options[o].value&&(n.selectedIndex=o,n.options[o].selected=!0)}else document.getElementById("W_EMAIL").value="",n&&(n.selectedIndex=0);checkPanDiscount()}function expireDateMaskClicked(){$("#EXPIRE_DATE_MASK_TD").hide(),$("#EXPIRE_DATE_TD").show(),document.getElementById("W_EXPIRE1").focus(),field=document.getElementById("W_EXPIRE1")}function isExpireDateVisible(){return!!$("#EXPIRE_DATE_TD").is(":visible")}function isSavedPanSelected(){var e=document.getElementById("MASKED_PAN_SELECT");if(!e)return!1;var t=e.options[e.selectedIndex];return"NO_PAN_SELECTED"!==t.id}function getSelectedPanId(){var e=document.getElementById("MASKED_PAN_SELECT");if(!e)return null;var t=e.options[e.selectedIndex];return t.id}function emailSelectChanged(){var e=document.getElementById("EMAIL_SELECT"),t=e.options[e.selectedIndex];document.getElementById("W_EMAIL").value=t.value}function checkPanDiscount(){if(1==document.getElementById("TERMINAL_DISCOUNT_STATUS").value){var e=new Intl.NumberFormat,t=document.getElementById("ORIGINAL_AMOUNT").value,n=e.format(t);document.getElementById("amount").value=n+" ریال";var d=document.getElementById("RefId").value,l="discount.mellat";if(isSavedPanSelected())prepare4DiscountServiceCall(),$.post(l,{W_REFID:d,SELECTED_PAN_ID:getSelectedPanId()},showDiscount);else{var o=!0,u=document.getElementById("W_PAN1").value;(""==u||u.length<4)&&(o=!1);var c=document.getElementById("W_PAN2").value;(""==c||c.length<4)&&(o=!1);var m=document.getElementById("W_PAN3").value;(""==m||m.length<4)&&(o=!1);var a=document.getElementById("W_PAN4").value;if((""==a||a.length<4||1e3>a)&&(o=!1),o){var i=a+m+c+u;prepare4DiscountServiceCall(),$.post(l,{W_REFID:d,PAN:i},showDiscount)}}}}function prepare4DiscountServiceCall(){isDiscountCheck=!0,document.getElementById("doPay").disabled=!0,document.getElementById("doCancel").disabled=!0}function openDiscountDialog(e,t){$("#discount-info-div").avgrund({width:280,height:126,holderClass:"custom",showClose:!1,onBlurContainer:".container",closeByDocument:!1,template:'<div class="discount-dialog-header">تخفیف</div><p>'+e+'</p><div class="discount-buttons-div"><input type="button" class="Public_Button" onclick="showAmountAfterDiscount(\''+t+'\')" value="تائید"/><input type="button" class="Public_Button" onclick="resetPan()" value="تغییر کارت"></div>'});var n=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});document.getElementById("discount-info-div").dispatchEvent(n)}function showAmountAfterDiscount(e){document.getElementById("amount").value=e+" ریال",closeDialog()}function resetPan(){resetPanInputs(),resetMaskedPanSelect(),closeDialog()}function closeDialog(){$("body").removeClass("avgrund-active"),setTimeout(function(){$(".avgrund-popin").remove()},500)}function resetMaskedPanSelect(){var e=document.getElementById("MASKED_PAN_SELECT");e&&(e.selectedIndex=0,e.options[0].selected=!0,panSelectChanged(e))}function resetPanInputs(){document.getElementById("W_PAN1").value="",document.getElementById("W_PAN2").value="",document.getElementById("W_PAN3").value="",document.getElementById("W_PAN4").value=""}var milisec=0,seconds=0,milisect=60,secondst=9;display();var shuffleArray=new Array,field="",isDiscountCheck=!1;shuffle=function(e){for(var t,n,d=e.length;d;t=parseInt(Math.random()*d),n=e[--d],e[d]=e[t],e[t]=n);for(var l=0;10>l;l++)shuffleArray[l]=e[l];return e};var showDiscount=function(e){if(e){e=JSON.parse(e);var t=new Intl.NumberFormat;if("SUCCESSFUL"===e.status){var n=t.format(e.discountAmount),d=t.format(e.amountAfterDiscount);if(0!=e.discountAmount){var l="به کارت شما "+n+" ریال تخفیف تعلق گرفت<br> مبلغ نهایی: "+d+" ریال";e.description&&(l+="<br>"+e.description),openDiscountDialog(l,d)}else if(e.description){var l="به کارت شما "+e.description+" تعلق گرفت<br>";openDiscountDialog(l,d)}$("#alert").attr("class",""),$("#alert").text(""),document.getElementById("doPay").disabled=!1,document.getElementById("doCancel").disabled=!1}else"MAX_DISCOUNT_CALL_EXCEEDED"===e.status?($("#alert").attr("class","Error"),$("#alert").text("تعداد دفعات تغییر شماره کارت بیش از حد مجاز است")):($("#alert").attr("class","Error"),$("#alert").text("خطای سیستمی"))}else $("#alert").attr("class","Error"),$("#alert").text("خطای سیستمی")};